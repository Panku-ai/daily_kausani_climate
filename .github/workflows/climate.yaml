name: Fetch Kausani Climate

on:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours
  workflow_dispatch:         # manual trigger

permissions:
  contents: write   # allow pushing changes back to the repo

jobs:
  fetch-climate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true   # ensures GITHUB_TOKEN is stored for push

      - name: Fetch climate data
        run: |
          MONTH=$(date +'%Y_%m')
          FILE="climate_${MONTH}.json"
          DATA=$(curl -s "https://wttr.in/Kausani?format=j1")
          echo "{\"timestamp\":\"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\",\"data\":${DATA}}" >> $FILE

      - name: Debug Git state
        run: |
          git remote -v
          git status

      - name: Commit and push JSON file
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Make sure we're up to date with remote main
          git fetch origin main
          git checkout main
          git rebase origin/main || git merge origin/main

          # Stage and commit changes
          git add climate_*.json
          git commit -m "Update Kausani climate data" || echo "No changes to commit"

          # Push safely
          git push origin main

          # Show last few commits for debugging
          git log --oneline --graph --decorate -n 5